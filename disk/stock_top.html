<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Daily</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus/dist/index.css">
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-plus"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-gl/dist/echarts-gl.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 10px;
            min-height: 100vh;
        }

        #app {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .chart-container {
            margin: 0 auto 20px;
            padding: 0 10px;
        }

        .chart-wrapper {
            width: 100%;
            aspect-ratio: 1;
            max-height: 400px;
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .chart-container {
                width: 95%;
                padding: 0;
            }

            .chart-wrapper {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
<div id="app">
    <el-row>
        <p>{{selectedIndustry}}</p>
    </el-row>
    <el-row :gutter="10" justify="center">
        <el-col 
            :xs="24" 
            :sm="24" 
            :md="12" 
            :lg="8" 
            v-for="index in 12" 
            :key="index"
            class="is-flex is-justify-center"
        >
            <div class="chart-container">
                <div class="chart-wrapper">
                    <div :id="`chart${index}`" style="width: 100%; height: 100%;"></div>
                </div>
            </div>
        </el-col>
    </el-row>
</div>
<script>
    const { createApp, onMounted, ref, reactive } = Vue;
    createApp({
        setup() {
            const charts = reactive({});
            const data = ref([]);
            const industryMap = ref({});
            const industryMapRevert = ref({});
            const selectedIndustry = ref(null);
            let selected = false;
            let input_year = '2024';
            const fixedColorList = ["#F0F0F0", "#FF5733", "#33FF57", "#5733FF", "#FF33E7", "#33E7FF", "#E7FF33", "#FF0000", "#00FF00", "#0000FF", "#FFFF00", "#FF00FF", "#00FFFF", "#FF8C00", "#8C00FF", "#00FF8C", "#FF008C", "#8CFF00", "#008CFF", "#FF4500", "#4500FF", "#00FF45", "#FF0045", "#45FF00", "#0045FF", "#FF1493", "#1493FF", "#93FF14", "#FF1400", "#1400FF", "#00FF14", "#FF9933", "#9933FF", "#33FF99", "#FF6347", "#6347FF", "#47FF63", "#FFD700", "#D700FF", "#00FFD7", "#FFC0CB", "#C0CBFF", "#CBFFC0", "#FFB6C1", "#B6C1FF", "#C1FFB6", "#FFA07A", "#A07AFF", "#7AFFA0", "#228B22", "#8B2222", "#22228B", "#800080", "#008080", "#808000", "#DA70D6", "#70D6DA", "#D6DA70", "#3CB371", "#B3713C", "#713C B3", "#6A5ACD", "#5ACD6A", "#CD6A5A", "#9370DB", "#70DB93", "#DB9370", "#00CED1", "#CED100", "#D100CE", "#48D1CC", "#D1CC48", "#CC48D1", "#9ACD32", "#ACD39A", "#D39A AC", "#F08080", "#8080F0", "#80F080", "#7FFFD4", "#FFD47F", "#D47FFF", "#66CDAA", "#CDAA66", "#AA66CD", "#40E0D0", "#E0D040", "#D040E0", "#ADD8E6", "#D8E6AD", "#E6AD D8", "#F0E68C", "#E68C F0", "#8C F0E6", "#E0FFFF", "#FFFFE0", "#FFE0FF"];
            const initChart = (idx) => {
                const chartDom = document.getElementById(`chart${idx}`);
                const chartInstance = echarts.init(chartDom);
                charts[`chart${idx}`] = chartInstance;

                const option = {
                    tooltip: {
                        formatter: function (p) {
                            const dateStr = p.data[0];
                            const industry = data.value.find(item => item[0] === dateStr)[1];
                            const industryName = industryMapRevert.value[industry];
                            return `${dateStr}: ${industryName}`;
                        }
                    },
                    calendar: [{
                        orient: 'vertical',
                        range: `${input_year}-${idx}`,
                        dayLabel: {
                            firstDay: 1,
                            nameMap: 'cn'
                        },
                        monthLabel: {
                            nameMap: 'cn'
                        },
                        yearLabel: { show: false },
                        cellSize: ['auto', 'auto']
                    }],
                    series: [{
                        type: 'heatmap',
                        coordinateSystem: 'calendar',
                        calendarIndex: 0,
                        data: data.value,
                        itemStyle: {
                            color: function (params) {
                                return fixedColorList[params.data[1]]
                            }
                        }
                    }]
                };
                chartInstance.setOption(option);
                chartInstance.on('click', function (params) {
                    selectedIndustry.value = industryMapRevert.value[params.data[1]]
                    heatmapClick(params.data[1])
                });

                window.addEventListener('resize', () => {
                    chartInstance.resize();
                });
            };


            // 更新每个图标的颜色
            function heatmapClick(industry_idx) {
                selected = !selected
                console.log(charts)
                for (let key in charts) {
                    let cur_config = charts[key].getOption();
                    if (selected) {
                        cur_config.series[0].itemStyle.color = function (params) {
                            if ( params.data[1] == industry_idx) {
                                return fixedColorList[params.data[1]]
                            } else {
                                return fixedColorList[0]
                            }
                        }     
                    } else {
                        cur_config.series[0].itemStyle.color = function (params) {
                                return fixedColorList[params.data[1]]
                        }   
                    }                
                    charts[key].setOption(cur_config)            
                }
            }

            // 构造数据
            function getCalendarData(year, rawData) {
                const dataMap = {};
                const industries = new Set();

                rawData.forEach(item => {
                    dataMap[item["日期"]] = item["行业"];
                    industries.add(item["行业"]);
                });

                const tempIndustryMap = { "休市": 0 };
                let currentNumber = 1;
                industries.forEach(industry => {
                    if (industry !== "休市") {
                        tempIndustryMap[industry] = currentNumber++;
                    }
                });
                const tempIndustryMapRevert = Object.fromEntries(
                    Object.entries(tempIndustryMap).map(([key, value]) => [value, key])
                );

                const tempDate = new Date(year + '-01-01');
                const end = new Date((+year + 1) + '-01-01');
                const tempData = [];

                while (tempDate < end) {
                    const dateStr = tempDate.toISOString().split('T')[0];
                    const industry = dataMap[dateStr] || '休市';
                    tempData.push([
                        dateStr,
                        tempIndustryMap[industry]
                    ]);
                    tempDate.setDate(tempDate.getDate() + 1);
                }
                data.value = tempData;
                industryMap.value = tempIndustryMap;
                industryMapRevert.value = tempIndustryMapRevert;
                console.log(industryMap.value)

                return { data: tempData, industryMap: tempIndustryMap, industryMapRevert: tempIndustryMapRevert };
            }

            onMounted(async () => {
                const url = window.location.href;
                const searchParams = new URLSearchParams(url.split('?')[1]);
                const date = searchParams.get('date');
                try {
                    const res = await fetch(`industry_top_${date}.json`);
                    const rawData = await res.json();
                    input_year = date.slice(0,4)
                    getCalendarData(input_year, rawData);
                    for (let index = 1; index <= 12; index++) {
                        initChart(index);                        
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            });
            return { 
                charts,
                selectedIndustry
            };
        }
    }).use(ElementPlus).mount('#app');
</script>
</html>
